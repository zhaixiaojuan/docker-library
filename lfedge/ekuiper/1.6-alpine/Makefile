# This file is generated by the template.

REGISTRY?=lcr.loongnix.cn
ORGANIZATION?=lfedge
REPOSITORY?=ekuiper
TAG?=1.6-alpine

IMAGE=$(REGISTRY)/$(ORGANIZATION)/$(REPOSITORY):$(TAG)

KUIPER?=kuiper-1.6.3-linux-loong64

TAR_GZ?=$(KUIPER).tar.gz

#URL?=https://github.com/Loongson-Cloud-Community/ekuiper/releases/download/1.6.3/kuiper-1.6.3-linux-loong64.tar.gz
URL?=http://cloud.loongnix.cn/releases/loongarch64/lf-edge/ekuiper/1.6.3/ekuiper-linux-loong64.tar.gz

default: image

check:
	@[ -f Dockerfile ] || (echo "error: Dockerfile has lost." ; exit 1)
	@[ -f docker-entrypoint.sh ] || (echo "error: docker-entrypoint.sh has lost." ; exit 1)
	@[ -d $(KUIPER) ] || (echo "$(KUIPER) is needed,downloading..." ;\
		unset http_proxy && \
		wget -O $(TAR_GZ) -q $(URL)&& \
		tar -zxf $(TAR_GZ) --strip-components 1 && \
		rm -f $(TAR_GZ) && \
		export http_proxy=$(https_proxy) && \
		echo "done.")	

image: check
	sudo docker build \
		--build-arg http_proxy=$(http_proxy) \
		--build-arg https_proxy=$(https_proxy) \
		-t $(IMAGE) \
		.

push:
	docker push $(IMAGE)

clean:
	@rm -rf $(KUIPER)*
